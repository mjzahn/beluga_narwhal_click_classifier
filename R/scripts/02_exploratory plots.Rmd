---
title: "Chap4_noise_exploration"
author: "Marie Zahn"
date: '2023-06-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
## load required packages
library(here)
library(ggplot2)
library(PAMpal)
library(banter)
library(dplyr)
library(randomForest)
library(rfPermute)

#Set time zone to UTC
Sys.setenv(TZ = 'UTC')
```
```{r load data}
# R data file (after filtering out events with less than 30 detections)
load(file=here('R/Rdata/1hr/Fish_20kHzPG_20kHzPP_1hr_wavTime_filtered_labeled.rdata'))
load(file=here('R/Rdata/1hr/Kong_20kHzPG_20kHzPP_1hr_wavTime_filtered_labeled.rdata'))

# # update file location in Binaries of the AcousticStudy object
# binUpd <- system.file('extdata', 'Binaries', package='PAMpal')
# dbUpd <- system.file('extdata', package='PAMpal')
# Fisher_2019_data_20kHz_new <- updateFiles(Fisher_2019_data_20kHz_new,bin="C:\\Users\\marie\\Documents\\PhD\\Chapter_4\\PAMGuard_ch4\\PAMGuard_ch4_initial_test\\Binaries",db="C:\\Users\\marie\\Documents\\PhD\\Chapter_4\\PAMGuard_ch4\\PAMGuard_ch4_initial_test")
```

```{r check # events for each group}

## Fisher
fish_beluga_dets <- fish_dets_20kHzPP_filter %>% filter(species=='X045')
fish_narwhal_dets <- fish_dets_20kHzPP_filter %>% filter(species=='X085')
fish_noise_dets <- fish_dets_20kHzPP_filter %>% filter(species=='NOISE')

## filtered
length(fish_beluga_dets@events)
length(fish_narwhal_dets@events)
length(fish_noise_dets@events)

## Kong Oscar
kong_beluga_dets <- kong_dets_20kHzPP_filter %>% filter(species=='X045')
kong_narwhal_dets <- kong_dets_20kHzPP_filter %>% filter(species=='X085')
kong_noise_dets <- kong_dets_20kHzPP_filter %>% filter(species=='NOISE')

## filtered
length(kong_beluga_dets@events)
length(kong_narwhal_dets@events)
length(kong_noise_dets@events)
```

*Fisher Islands*
Beluga events:
- Event 949, 955, and 961 were not included in final plots (zero to <5 detections)
    - 961 - can see echolocation and these clicks weren't detected probably because of the SPL threshold (should try 40-50 kHz instead of 30-40 as upper limit comparison)
Narwhal events:
- 686, 708, 756, 775, 886, 908, 918 had zero detections except for 686 that had 2.

Observation from data in Raven:
686 - ~4 clicks
708 - ~6 clicks
756 - super faint and skeptical - I don't really see click trains here (I would remove this detection)
775 - ~3 clicks - also very faint and I'm not sure whether we should include
886 - maybe 1 or two clicks? Wouldn't include
908 - faint - see ~4-6 clicks
918 - don't see clicks here

*Kong Oscar*
Beluga events:
- Event 252 and 303 were not included in final plots (zero to <5 detections) - these events only contained whistles/calls other than EC
Narwhal events:
- All 40 in final plots


```{r compare my detections to Michael}
## load csvs of detections
fish_det_1hr_csv <- read.csv(here('R/spreadsheets/1hr/Fisher_2019_species_ids_1hr_wavTime_labeled.csv'))
kong_det_1hr_csv <- read.csv(here('R/spreadsheets/1hr/Kong_2019_species_ids_1hr_wavTime_labeled.csv'))

fish_det_1hr_csv

## summarize hourly detections to 6-hr
fish_dets_20kHzPP %>% group_by(Date=floor_date(Date, "1 hour")) %>%
  summarize(c1=sum(c1), c2=sum(c2), c3=sum(c3))


```


```{r}
library(dplyr)
library(hrbrthemes)
library(viridis)
# plot data
ggplot(clicks_df, aes(x=species, y=dB_20kHz)) + 
  geom_boxplot() + theme_bw()
# plot data for clicks with RL > 130
loud_clicks <- dplyr::filter(clicks_df, RL>160)
ggplot(loud_clicks, aes(x=species, y=dB_20kHz)) + 
    geom_violin(width=1.4) +
    geom_boxplot(width=0.1, color="grey", alpha=0.2) +
    scale_fill_viridis(discrete = TRUE) +
    theme_minimal() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    xlab("")

# plot data in box plots
beluga_clicks_df <- dplyr::filter(clicks_df, species=='X045')
narwhal_clicks_df <- dplyr::filter(clicks_df, species=='X085')

# get sample size of each
length(beluga_clicks_df$UID)
length(narwhal_clicks_df$UID)

mean(beluga_clicks_df$dB_20kHz)
mean(narwhal_clicks_df$dB_20kH)

narwhal_df <- data.frame(freq = click_specs_narwhal, 
                         species = rep('narwhal', length(click_specs_narwhal[,1])))
beluga_df <- data.frame(freq = click_specs_beluga, 
                         species = rep('beluga', length(click_specs_beluga[,1])))
whale_20to25kHz <- rbind(narwhal_df, beluga_df)

ggplot(whale_20to25kHz, aes(x=species, y=freq)) + 
  geom_boxplot() + theme_bw()

## do an ANOVA
# Compute the analysis of variance
res.aov <- aov(freq ~ species, data = whale_20to25kHz)
# Summary of the analysis
summary(res.aov)

# plot data
ggplot(clicks_df, aes(x=species, y=dB_20kHz)) + 
  geom_boxplot() + theme_bw()
# plot data for clicks with RL > 130
loud_clicks <- dplyr::filter(clicks_df, RL>160)
ggplot(loud_clicks, aes(x=species, y=dB_20kHz)) + 
  geom_boxplot() + theme_bw()

# plot data in box plots
beluga_clicks_df <- dplyr::filter(clicks_df, species=='X045')
narwhal_clicks_df <- dplyr::filter(clicks_df, species=='X085')

mean(beluga_clicks_df$dB_20kHz)
mean(narwhal_clicks_df$dB_20kH)

narwhal_df <- data.frame(freq = click_specs_narwhal, 
                         species = rep('narwhal', length(click_specs_narwhal[,1])))
beluga_df <- data.frame(freq = click_specs_beluga, 
                         species = rep('beluga', length(click_specs_beluga[,1])))
whale_20to25kHz <- rbind(narwhal_df, beluga_df)

ggplot(whale_20to25kHz, aes(x=species, y=freq)) + 
  geom_boxplot() + theme_bw()

## do an ANOVA
# Compute the analysis of variance
res.aov <- aov(freq ~ species, data = whale_20to25kHz)
# Summary of the analysis
summary(res.aov)


```

## Find difference in SPL between 20 kHz and other frequency bands

```{r}
library(ggpubr)
clicks_df = read.csv("Rdata/campbell_subset/Campbell-beluga_narwhal_click_data_BW10dB-over10.csv")

# rename codes as species names
clicks_df$species[clicks_df$species=="X045"] <- "Beluga"
clicks_df$species[clicks_df$species=="X085"] <- "Narwhal"

# filter out only clicks with RL > 120
clicks_df_loud <- dplyr::filter(clicks_df, RL>120)

clicks_df_loud %>% mutate(dB15_20 = dB_20kHz-dB_15kHz) %>% 

ggplot(aes(x=species, y=dB15_20, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("15/20 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.8, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

clicks_minus_dB_20kHz <- clicks_df_loud %>% mutate(across(dB_20kHz:dB_70kHz,~.-clicks_df_loud$dB_20kHz))

dB30kHz = ggplot(clicks_minus_dB_20kHz, aes(x=species, y=dB_30kHz, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("20/30 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.6, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

dB40kHz = ggplot(clicks_minus_dB_20kHz, aes(x=species, y=dB_40kHz, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("20/40 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.6, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

dB50kHz = ggplot(clicks_minus_dB_20kHz, aes(x=species, y=dB_50kHz, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("20/50 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.6, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

dB60kHz = ggplot(clicks_minus_dB_20kHz, aes(x=species, y=dB_60kHz, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("20/60 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.6, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

dB70kHz = ggplot(clicks_minus_dB_20kHz, aes(x=species, y=dB_70kHz, fill=species)) + 
    geom_violin(width=0.2) +
    scale_fill_brewer(palette="Accent",labels=c('Beluga', 'Narwhal')) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    theme_minimal() +
    ylab("SPL (dB re 1 uPa)") +
    xlab("") +
    ggtitle("20/70 kHz") +
    theme(legend.position = "none") +
    stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red") +
    stat_summary(fun.y=mean, colour="red", geom="text", show_guide = FALSE, 
               vjust=-0.7, hjust=1.6, aes(label=round(..y.., digits=1))) +
    ylim(-60,60)

ggarrange(dB30kHz, dB40kHz, dB50kHz, dB60kHz, dB70kHz + rremove("x.text"), 
          labels = c("a", "b", "c", "d", "e"),
          ncol = 2, nrow = 3)

```

```{r look at all data}
## look at data

## Kong Oscar ----------
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='241', sort=TRUE) # noise
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='243', sort=TRUE) # noise
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='248', sort=TRUE) # noise
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='249', sort=TRUE) # narwhal??
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='256', sort=TRUE) # noise

calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='242', sort=TRUE) # narwhals
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='244', sort=TRUE) # narwhals
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='247', sort=TRUE) # narwhals

calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='252', sort=TRUE) # belugas
calculateAverageSpectra(Kong19_subset_dets_20kHzPG_15kHzPP, evNum='253', sort=TRUE) # belugas

## Fisher islands ----------
calculateAverageSpectra(Fisher19_subset_dets_20kHzPG_15kHzPP,evNum='2',sort=TRUE) # narwhals
calculateAverageSpectra(Fisher19_subset_dets_20kHzPG_15kHzPP,evNum='3',sort=TRUE) # narwhals
calculateAverageSpectra(Fisher19_subset_dets_20kHzPG_15kHzPP,evNum='6',sort=TRUE) # narwhals
```


```{r look at detector 1 clicks}
## see properties of clicks with peak frequencies between 4-20 kHz
kong19_subset_det1 <- Kong19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_1')
calculateAverageSpectra(kong19_subset_det1, evNum='242', sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det1, evNum='247', sort=TRUE) # narwhals

fish19_subset_det1 <- Fisher19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_1')
calculateAverageSpectra(fish19_subset_det1, evNum='2', sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det1, evNum='3', sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det1, evNum='6', sort=TRUE) # narwhals

## ^ based on these results, we can reasonably discard detector 1 clicks

```

```{r look at detector 2 clicks}
## see properties of clicks with peak frequencies between 20-50 kHz
#### kong oscar
kong19_subset_det2 <- Kong19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_2')
calculateAverageSpectra(kong19_subset_det2, evNum='242',sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det2, evNum='242',filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det2, evNum='247',filterfrom_khz = 15,sort=TRUE) # narwhals
# save(kong19_subset_det2, file=here('final_test/Rdata/Kong19_subset_det2_6hourly.rdata'))

## filter clicks to ensure they only have peak freq = 20-50 kHz and replot
kong19_subset_det2_clean <- kong19_subset_det2 %>% filter(peak>20 & peak<50) %>% filter(BW_10dB>5)
calculateAverageSpectra(kong19_subset_det2_clean, evNum='242', sort=TRUE) # narwhals
## ^ these filters remove some narwhal clicks and do not nicely remove all noise, so not really worth using

det2_peak = kong19_subset_det2@events[["242"]]@detectors[["Click_Detector_2"]][["peak"]]

#### fisher
fish19_subset_det2 <- Fisher19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_2')
calculateAverageSpectra(fish19_subset_det2, evNum='2',sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det2, evNum='2',filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det2, evNum='6',filterfrom_khz = 15,sort=TRUE) # narwhals
save(fish19_subset_det2, file=here('final_test/Rdata/Fish19_subset_det2_6hourly.rdata'))

## filter clicks to ensure they only have peak freq = 20-50 kHz and replot
fish19_subset_det2_clean <- fish19_subset_det2 %>% filter(peak>20 & peak<50) %>% filter(BW_10dB>5)
calculateAverageSpectra(fish19_subset_det2_clean, evNum='2', sort=TRUE) # narwhals
```


```{r look at detector 3 clicks}
## see properties of clicks with peak frequencies between 50-70 kHz
kong19_subset_det3 <- Kong19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_3')
calculateAverageSpectra(kong19_subset_det3, evNum='242', sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det3, evNum='242', filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det3, evNum='247', sort=TRUE) # narwhals

fish19_subset_det3 <- Fisher19_subset_dets_20kHzPG_15kHzPP %>% filter(detectorName=='Click_Detector_3')
calculateAverageSpectra(fish19_subset_det3, evNum='2', sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det3, evNum='2', filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det3, evNum='6', sort=TRUE) # narwhals

```

```{r look at detector 2 and 3 clicks}
## see properties of clicks with peak frequencies between 50-70 kHz
kong19_subset_det23 <- Kong19_subset_dets_20kHzPG_15kHzPP %>% 
  filter(detectorName=='Click_Detector_2'|detectorName=='Click_Detector_3')
calculateAverageSpectra(kong19_subset_det23, evNum='242', sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det23, evNum='242', filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(kong19_subset_det23, evNum='247', sort=TRUE) # narwhals
# save(kong19_subset_det23, file=here('final_test/Rdata/Kong19_subset_det23_6hourly.rdata'))

## see properties of clicks with peak frequencies between 50-70 kHz
fish19_subset_det23 <- Fisher19_subset_dets_20kHzPG_15kHzPP %>% 
  filter(detectorName=='Click_Detector_2'|detectorName=='Click_Detector_3')
calculateAverageSpectra(fish19_subset_det23, evNum='242', sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det23, evNum='242', filterfrom_khz = 15,sort=TRUE) # narwhals
calculateAverageSpectra(fish19_subset_det23, evNum='247', sort=TRUE) # narwhals
# save(fish19_subset_det23, file=here('final_test/Rdata/Kong19_subset_det23_6hourly.rdata'))

```

