---
title: "test_beluga_narwhal_classifier"
author: "Marie Zahn"
date: '2022-07-12'
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set up workspace}
## load required packages
library(ggplot2)
library(PAMpal)
library(banter)
library(dplyr)
library(randomForest)
library(rfPermute)
library(here)

#Set time zone to UTC
Sys.setenv(TZ = 'UTC')

## install PAMpal package from GitHub
# devtools::install_github('TaikiSan21/PAMpal')
## install BANTER package from GitHub
# devtools::install_github('ericarcher/banter')

```

```{r load data}
## model without noise category and with SPL variables
load(file=here('R/Rdata/train_bant_mdl.rdata'))
load(file=here('R/Rdata/train_bant_mdl_tol.rdata'))
## model without noise category and without SPL variables
load(file=here('R/Rdata/bant_mdl_new.rdata'))

## load testing data
## these data were processed in PAMpal with 20 kHz highpass filter (and SPL calcs) and events that had few detections were removed
load(here("R/Rdata/test_data_fish.rdata"))
load(here("R/Rdata/test_data_kong.rdata"))

## load testing data that includes SPL diff calculated with 0 kHz highpass filter
load(here("R/Rdata/test_data_fish_0kHz-spl.Rdata"))
load(here("R/Rdata/test_data_fish_0kHz-spl_tol.Rdata"))
load(here("R/Rdata/test_data_kong_0kHz-spl.Rdata"))
load(here("R/Rdata/test_data_kong_0kHz-spl_tol.Rdata"))

```

```{r look at training model with spl diff}
## look at training model with SPL diff
summary(bant.mdl)

## get RF data from banter model
event.rf <- getBanterModel(bant.mdl, "event")
rfPermute::plotProximity(event.rf)
model_predictions <- casePredictions(event.rf)
model_predictions %>% filter(original=='X045',predicted=='X085')

## load training data
load(file=here('R/Rdata/train_data.rdata'))

## update path
train_data <- updateFiles(train_data, bin = "E:/MS_Chapter_2/PAMGuard/Binaries", db = "E:/MS_Chapter_2/PAMGuard/PAM20103_Zahn_narluga-ECdetection.sqlite3")

## plot beluga event that was misclassified
calculateAverageSpectra(train_data,evNum = 'PAM20103_Zahn_narluga-ECdetection.OE37')
calculateAverageSpectra(train_data,evNum = 'PAM20103_Zahn_narluga-ECdetection.OE84') # misclassified
calculateAverageSpectra(train_data,evNum = 'PAM20103_Zahn_narluga-ECdetection.OE85') # beluga
calculateAverageSpectra(train_data,evNum = 'PAM20103_Zahn_narluga-ECdetection.OE86') # beluga
```

## Test banter model with SoundTrap data - without SPL vars

```{r test whale model without SPL vars}
## remove noise events
fish_whale_data <- fish_test_data %>% filter(species!='NOISE')
kong_whale_data <- kong_test_data %>% filter(species!='NOISE')

## Export data from AcousticStudy into format required to run a BANTER model
## Fisher islands
banter_fish <- export_banter(fish_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime', 'spl_16to23_dB', 'spl_23to46_dB'))
## Kong Oscar
banter_kong <- export_banter(kong_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime', 'spl_16to23_dB', 'spl_23to46_dB'))

# filter out clicks that were not detected in click detector 2
banter_fish$detectors$Click_Detector_2<-filter(banter_fish$detectors$Click_Detector_2, peak>20 & peak<50)
banter_fish$detectors$Click_Detector_3<-filter(banter_fish$detectors$Click_Detector_3, peak>50 & peak<70)

banter_kong$detectors$Click_Detector_2<-filter(banter_kong$detectors$Click_Detector_2, peak>20 & peak<50)
banter_kong$detectors$Click_Detector_3<-filter(banter_kong$detectors$Click_Detector_3, peak>50 & peak<70)

# predict species with novel data
# score_Fisher <- predict(bant.mdl_new, banter_Fisher)
score_fish_whale <- predict(bant.mdl_new, banter_fish)
score_fish_whale

# save model result
save(score_fish_whale, file=here("R/Rdata/model_results/score_fish_whale.rdata"))

# score_kong <- predict(bant.mdl_new, banter_kong)
score_kong_whale <- predict(bant.mdl_new, banter_kong)
score_kong_whale

## look at beluga predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "X045",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "X045",]

## look at narwhal predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "X085",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "X085",]

```

## Save model output and scores

```{r save classification scores}
save(score_fish_whale,file=here('R/Rdata/score_fish_whale.rdata'))
save(score_kong_whale,file=here('R/Rdata/score_kong_whale.rdata'))

write.csv(score_kong_whale$predict.df, here('R/Kong_scores_whale.csv'))
write.csv(score_fish_whale$predict.df, here('R/Fish_scores_whale.csv'))
```

## Test banter model with SoundTrap data - with SPL vars calculated with 20 kHz highpass

```{r test whale model with SPL vars}
## remove noise events
fish_whale_data <- fish_test_data %>% filter(species!='NOISE')
kong_whale_data <- kong_test_data %>% filter(species!='NOISE')

## Export data from AcousticStudy into format required to run a BANTER model
## Fisher islands
banter_fish_spl <- export_banter(fish_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime'))
## Kong Oscar
banter_kong_spl <- export_banter(kong_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime'))

# filter out clicks that were not detected in click detector 2
banter_fish_spl$detectors$Click_Detector_2<-filter(banter_fish_spl$detectors$Click_Detector_2, peak>20 & peak<50)
banter_fish_spl$detectors$Click_Detector_3<-filter(banter_fish_spl$detectors$Click_Detector_3, peak>50 & peak<70)

banter_kong_spl$detectors$Click_Detector_2<-filter(banter_kong_spl$detectors$Click_Detector_2, peak>20 & peak<50)
banter_kong_spl$detectors$Click_Detector_3<-filter(banter_kong_spl$detectors$Click_Detector_3, peak>50 & peak<70)

# predict species with novel data
# score_Fisher <- predict(bant.mdl_new, banter_Fisher)
score_fish_whale_spl <- predict(bant.mdl, banter_fish_spl)
score_fish_whale_spl

# save model result
save(score_fish_whale, file=here("R/Rdata/model_results/score_fish_whale.rdata"))

# score_kong <- predict(bant.mdl_new, banter_kong)
score_kong_whale_spl <- predict(bant.mdl, banter_kong_spl)
score_kong_whale_spl

## look at beluga predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "X045",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "X045",]

## look at narwhal predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "X085",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "X085",]

## look at noise predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "NOISE",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "NOISE",]

```


## Test banter model with SoundTrap data - with SPL vars calculated with 0 kHz highpass

```{r test whale model with SPL vars}
## remove noise events
fish_whale_data <- fish_test_data %>% filter(species!='NOISE')
kong_whale_data <- kong_test_data %>% filter(species!='NOISE')

## Export data from AcousticStudy into format required to run a BANTER model
## Fisher islands
banter_fish_spl <- export_banter(fish_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime'))
## Kong Oscar
banter_kong_spl <- export_banter(kong_whale_data,
                             dropVars = c('noiseLevel', 'dBPP', 'peakTime'))

# filter out clicks that were not detected in click detector 2
banter_fish_spl$detectors$Click_Detector_2<-filter(banter_fish_spl$detectors$Click_Detector_2, peak>20 & peak<50)
banter_fish_spl$detectors$Click_Detector_3<-filter(banter_fish_spl$detectors$Click_Detector_3, peak>50 & peak<70)

banter_kong_spl$detectors$Click_Detector_2<-filter(banter_kong_spl$detectors$Click_Detector_2, peak>20 & peak<50)
banter_kong_spl$detectors$Click_Detector_3<-filter(banter_kong_spl$detectors$Click_Detector_3, peak>50 & peak<70)

# predict species with novel data
# score_Fisher <- predict(bant.mdl_new, banter_Fisher)
score_fish_whale_spl <- predict(bant.mdl, banter_fish_spl)
score_fish_whale_spl

# save model result
save(score_fish_whale, file=here("R/Rdata/model_results/score_fish_whale.rdata"))

# score_kong <- predict(bant.mdl_new, banter_kong)
score_kong_whale_spl <- predict(bant.mdl, banter_kong_spl)
score_kong_whale_spl

## look at beluga predictions
score_fish_whale_spl$predict.df[score_fish_whale_spl$predict.df$original == "X045",]
score_kong_whale_spl$predict.df[score_kong_whale_spl$predict.df$original == "X045",]

## look at narwhal predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "X085",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "X085",]

## look at noise predictions
score_fish_whale$predict.df[score_fish_whale$predict.df$original == "NOISE",]
score_kong_whale$predict.df[score_kong_whale$predict.df$original == "NOISE",]

```



## Save model output and scores

```{r save classification scores}
save(score_fish_whale,file=here('R/Rdata/score_fish_whale.rdata'))
save(score_kong_whale,file=here('R/Rdata/score_kong_whale.rdata'))

write.csv(score_kong_whale$predict.df, here('R/Kong_scores_whale.csv'))
write.csv(score_fish_whale$predict.df, here('R/Fish_scores_whale.csv'))
```

# Need to look at events 293 and 299

```{r avg spectra and concat spectrogram}
# average spectra for all beluga events
calculateAverageSpectra(Fisher_2019_data_20kHz,299,plot=TRUE, noise = FALSE,
                        filterfrom_khz = 0)

# look at average spectra and spectrograms for beluga events that were misclassified (293,299) and correctly classified (305)
calculateAverageSpectra(Fisher_2019_data_20kHz,249,plot=TRUE, noise = FALSE,
                        filterfrom_khz = 20)

calculateAverageSpectra(Fisher_2019_data_20kHz,249,plot=TRUE, noise = FALSE,
                        filterfrom_khz = 20)

# look at average spectra and spectrograms for narwhal events that were
# correctly classified (30, 98, 206)
calculateAverageSpectra(Fisher_2019_data_20kHz,30,plot=TRUE,
                        filterfrom_khz = 20, noise=TRUE)

# can also look at events that were classified as narwhal events but were not labeled by Michael to be so: 20, 16, 46 (selected randomly). Event 20 might actually be narwhals

```

## Print out scores

```{r}
write.csv(score_Fisher$predict.df, 'Fisher_scores.csv')
```

## Look at events for false positives

```{r}
# Change banterData to whatever the name of your banter ready data is
oneEvDets <- banterWHICEAS20$detectors
# Change this to whatever event you are interested in
evKeep <- c('279')
for(d in seq_along(oneEvDets)) {
    oneEvDets[[d]] <- filter(oneEvDets[[d]], event.id %in% evKeep)
}
# dropping any detectors that were not in this event
nDets <- sapply(oneEvDets, nrow)
EvDetsW279 <- oneEvDets[nDets > 0]
# This is now a list of detectors that only have that event info
```
