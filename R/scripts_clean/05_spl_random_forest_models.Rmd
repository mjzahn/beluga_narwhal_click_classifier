---
title: "Random Forest"
output: pdf_document
date: "2023-07-25"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
## load required packages
library(here)
library(ggplot2)
library(PAMpal)
library(dplyr)
library(tidyr)
library(randomForest)
library(rfPermute)
```

```{r use SPL difference - pooled data}
fish_test_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/testing_fish_data_spl_diff_0kHz_highpass.csv"))
kong_test_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/testing_kong_data_spl_diff_0kHz_highpass.csv"))

## select columns we need
fish_test_data_select <- fish_test_data %>% 
  select(c(species,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>%
  filter(species!='NOISE')
kong_test_data_select <- kong_test_data %>% 
  select(c(species,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>% 
  filter(species!='NOISE')

SPL_diff_df_all <- rbind(fish_test_data_select,kong_test_data_select)
```


```{r modified code from rfPermute confusionMatrix func}
# function to calculate prediction interval from output of predict() function
confusionMatrix_predict <- function(predict_output, SPL_diff_df) {
  ## make confusion matrix
  cm <- table(SPL_diff_df[,1], predict_output)
  
  # binomial test
  conf.level = 0.95
  threshold = NULL
  
  # Confusion matrix and counts
  # cm <- .confMat(rf)
  class.n <- rowSums(cm)
  all.n <- c(class.n, Overall = sum(class.n))
  total.n <- sum(class.n)
  correct.n <- diag(cm)
  correct.n <- c(correct.n, Overall = sum(correct.n))
    
  # Confidence intervals
  ci <- t(sapply(
    mapply(
      stats::binom.test, 
      x = correct.n, 
      n = all.n, 
      p = correct.n / all.n, 
      conf.level = conf.level,
      SIMPLIFY = FALSE
    ),
    function(x) x$conf.int * 100
  ))
  colnames(ci) <- paste(c("LCI", "UCI"), conf.level, sep = "_")
  
  # Probability threshold
  prob.gt <- NULL
  if(!is.null(threshold)) {
    prob.gt <- lapply(threshold, function(p) {
      stats::pbinom(correct.n, total.n, p)
    })
    prob.gt <- do.call(cbind, prob.gt)
    colnames(prob.gt) <- paste0("Pr.gt_", threshold)
  }
  
  cm <- rbind(cm, Overall = rep(NA, ncol(cm)))
  pct.correct <- (correct.n / all.n) * 100
  cbind(
    cm, 
    pct.correct = pct.correct[rownames(cm)], 
    ci[rownames(cm), , drop = FALSE],
    prob.gt
  )
}


```

```{r run model}
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## Run random forest model with selected frequency bands
ranfor_soundtrap_spl <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB,
                                     data = SPL_diff_df_all, 
                                     ntree = 10000, 
                                     importance = TRUE,
                                     replace = TRUE, 
                                     proximity = TRUE)

ranfor_soundtrap_spl
confusionMatrix(ranfor_soundtrap_spl)

classPriors(ranfor_soundtrap_spl,sampsize = c(1,1))
pctCorrect(ranfor_soundtrap_spl)
varImpPlot(ranfor_soundtrap_spl)

## Run random forest model with TOL frequency bands
ranfor_soundtrap_spl_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB,
                                         data = SPL_diff_df_all, 
                                         ntree = 10000, 
                                         importance = TRUE,
                                         replace = TRUE, 
                                         proximity = TRUE)

ranfor_soundtrap_spl_tol
confusionMatrix(ranfor_soundtrap_spl)

varImpPlot(ranfor_soundtrap_spl_tol)
casePredictions(ranfor_soundtrap_spl_tol)

```

```{r box plots SPL}
## select columns we need
fish_test_data_select <- fish_test_data %>% 
  select(c(species,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>%
  filter(species!='NOISE')
kong_test_data_select <- kong_test_data %>% 
  select(c(species,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>% 
  filter(species!='NOISE')

SPL_diff_df_all <- rbind(fish_test_data_select,kong_test_data_select)

SPL_diff_df_long <- SPL_diff_df_all %>% pivot_longer(!c(species), names_to = "variable", values_to = "values")

ggplot(SPL_diff_df_long, aes(x = species, y = values))+
  geom_boxplot()+
  facet_wrap(.~variable, scales = "free")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r random forest for reson data}
## load training 2013 data with SPL calculations
train_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/training_data_spl_diff.csv"))

## select columns we need
train_spl_data <- train_data %>% select(c(species,spl_diff_16to23_dB,spl_diff_23to46_dB,
                                          spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB))

## modify species code to match testing dataset
train_spl_data$species[train_spl_data$species==85] <- 'X085'
train_spl_data$species[train_spl_data$species==45] <- 'X045'

## make sure species is a factor
train_spl_data$species <- as.factor(train_spl_data$species)

## run random forest model with target frequency bands
ranfor_reson <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = train_spl_data, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_reson
confusionMatrix(ranfor_reson)
casePredictions(ranfor_reson)
varImpPlot(ranfor)

## run random forest model with TOL frequency bands
ranfor_reson_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = train_spl_data, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_reson_tol
confusionMatrix(ranfor_reson_tol)
casePredictions(ranfor)

varImpPlot(ranfor)

```

```{r use reson data to predict SoundTrap}
## model with specific frequency band vars
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## model with specific freq bands ---------------------------
# y_pred <- predict(ranfor_reson, newdata=SPL_diff_df_all[,2:3], type='prob') # to get votes for each event
y_pred <- predict(ranfor_reson, newdata=SPL_diff_df_all[,2:3])
## make confusion matrix with confidence intervals
confusionMatrix_predict(y_pred,SPL_diff_df_all)

## model with TOL vars ---------------------------
y_pred <- predict(ranfor_reson_tol, newdata=SPL_diff_df_all[,4:5])
confusionMatrix_predict(y_pred,SPL_diff_df_all)

```


```{r use SoundTrap to predict reson}
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## model with specific freq bands
y_pred <- predict(ranfor_soundtrap_spl, newdata=train_spl_data[,2:3])
confusionMatrix_predict(y_pred,train_spl_data)

## model with tol bands
y_pred <- predict(ranfor_soundtrap_spl_tol, newdata=train_spl_data[,4:5])
confusionMatrix_predict(y_pred,train_spl_data)

```

```{r run separate RF models for Fisher and Kong}
## make sure species is a factor
fish_test_data_select$species <- as.factor(fish_test_data_select$species)
kong_test_data_select$species <- as.factor(kong_test_data_select$species)

## run random forest model
ranfor_fish <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = fish_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_fish
confusionMatrix(ranfor_fish)

## run random forest model - TOL
ranfor_fish_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = fish_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_fish_tol
confusionMatrix(ranfor_fish_tol)

## run random forest model
ranfor_kong <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = kong_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_kong
confusionMatrix(ranfor_kong)

ranfor_kong_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = kong_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = TRUE, 
                       proximity = TRUE)

ranfor_kong_tol
confusionMatrix(ranfor_kong_tol)

```

```{r Use one dataset to predict the other}
## with selected freq bands ------------------
y_pred_kong <- predict(ranfor_fish, newdata=kong_test_data_select[,2:3])
confusionMatrix_predict(y_pred_kong,kong_test_data_select)

y_pred_fish <- predict(ranfor_kong, newdata=fish_test_data_select[,2:3])
confusionMatrix_predict(y_pred_fish,fish_test_data_select)

## with TOL bands ------------------
y_pred_kong_tol <- predict(ranfor_fish_tol, newdata=kong_test_data_select[,4:5])
confusionMatrix_predict(y_pred_kong_tol,kong_test_data_select)

y_pred_fish_tol <- predict(ranfor_kong_tol, newdata=fish_test_data_select[,4:5])
confusionMatrix_predict(y_pred_fish_tol,fish_test_data_select)
```

