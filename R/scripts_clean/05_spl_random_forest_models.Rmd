---
title: "Random Forest"
output: pdf_document
date: "2023-07-25"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
## load required packages
library(here)
library(ggplot2)
library(PAMpal)
library(dplyr)
library(tidyr)
library(randomForest)
library(rfPermute)
```

# Load Data

```{r use SPL difference - pooled data}
fish_test_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/testing_fish_data_spl_diff_0kHz_highpass.csv"))
kong_test_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/testing_kong_data_spl_diff_0kHz_highpass.csv"))

## select columns we need
fish_test_data_select <- fish_test_data %>% 
  select(c(species,eventId,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>%
  filter(species!='NOISE')
kong_test_data_select <- kong_test_data %>% 
  select(c(species,eventId,spl_diff_16to23_dB,spl_diff_23to46_dB,
           spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB)) %>% 
  filter(species!='NOISE')

SPL_diff_df_all <- rbind(fish_test_data_select,kong_test_data_select)
```

```{r confusionMatrix func}
## modified code from rfPermute confusionMatrix func
## function to calculate prediction interval from output of predict() function
confusionMatrix_predict <- function(predict_output, SPL_diff_df) {
  ## make confusion matrix
  cm <- table(SPL_diff_df[,1], predict_output)
  
  # binomial test
  conf.level = 0.95
  threshold = NULL
  
  # Confusion matrix and counts
  # cm <- .confMat(rf)
  class.n <- rowSums(cm)
  all.n <- c(class.n, Overall = sum(class.n))
  total.n <- sum(class.n)
  correct.n <- diag(cm)
  correct.n <- c(correct.n, Overall = sum(correct.n))
    
  # Confidence intervals
  ci <- t(sapply(
    mapply(
      stats::binom.test, 
      x = correct.n, 
      n = all.n, 
      p = correct.n / all.n, 
      conf.level = conf.level,
      SIMPLIFY = FALSE
    ),
    function(x) x$conf.int * 100
  ))
  colnames(ci) <- paste(c("LCI", "UCI"), conf.level, sep = "_")
  
  # Probability threshold
  prob.gt <- NULL
  if(!is.null(threshold)) {
    prob.gt <- lapply(threshold, function(p) {
      stats::pbinom(correct.n, total.n, p)
    })
    prob.gt <- do.call(cbind, prob.gt)
    colnames(prob.gt) <- paste0("Pr.gt_", threshold)
  }
  
  cm <- rbind(cm, Overall = rep(NA, ncol(cm)))
  pct.correct <- (correct.n / all.n) * 100
  cbind(
    cm, 
    pct.correct = pct.correct[rownames(cm)], 
    ci[rownames(cm), , drop = FALSE],
    prob.gt
  )
}

```


```{r RF sensitivity analysis function}
## run the RF model over all combinations of sampsize

RF_sampsize_sensitivity_tol <- function(SPL_diff_df) {
  ## make master df with all possible combinations of sampsize
  sampsize_max <- length(SPL_diff_df$species[SPL_diff_df$species=='X045'])-1
  sampsize <- c(2:sampsize_max)
  
  ## loop over all possible combinations
  master_df <- as.data.frame(matrix(nrow = length(sampsize), ncol = 1))
  yy <- SPL_diff_df$species
  
  for (i in 1:length(sampsize)){
    ranfor <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB,
                           data = SPL_diff_df, 
                           ntree = 10000, 
                           importance = TRUE,
                           replace = FALSE,
                           sampsize = rep(sampsize[i],2),
                           proximity = TRUE)
    
    ## calculate accuracy
    rfpred <- predict(ranfor)
    accuracy <- caret::confusionMatrix(rfpred, yy)
    master_df[i,1] <- accuracy$overall[1]
    
  }
  
  ## combine dfs
  sensitivity <- cbind(sampsize, master_df)
  print(sensitivity)
  
  ## calculate % range of model output
  max(sensitivity$V1) - min(sensitivity$V1)
}

```

# Build randomForests for SoundTrap and Reson data

```{r randomForest for soundtrap data}
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## Run random forest model with TOL frequency bands
## calculate sampsize as half the sample size of the smaller species class (=beluga)
rf_sampsize <- ceiling(length(SPL_diff_df_all$species[SPL_diff_df_all$species=='X045'])/2)

ranfor_soundtrap_spl_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB,
                                         data = SPL_diff_df_all, 
                                         ntree = 10000, 
                                         importance = TRUE,
                                         replace = FALSE,
                                         sampsize = c(rf_sampsize,rf_sampsize),
                                         proximity = TRUE)

ranfor_soundtrap_spl_tol
confusionMatrix(ranfor_soundtrap_spl_tol)

## calculate accuracy and sensitivity to sampsize parameter
RF_sampsize_sensitivity_tol(SPL_diff_df_all)
# accuracy varies by <0.5%

## other model diagnostics
plotTrace(ranfor_soundtrap_spl_tol)
plotVotes(ranfor_soundtrap_spl_tol)
varImpPlot(ranfor_soundtrap_spl_tol)
importance(ranfor_soundtrap_spl_tol)
casePredictions(ranfor_soundtrap_spl_tol)

## look at one narwhal event that was misclassified
predictions <- casePredictions(ranfor_soundtrap_spl_tol)
predictions[predictions$is.correct==FALSE,]
SPL_diff_df_all[predictions$is.correct==FALSE,] # event 757


## Run random forest model with selected frequency bands
## calculate sampsize as half the sample size of the smaller species class (=beluga)
rf_sampsize <- ceiling(length(SPL_diff_df_all$species[SPL_diff_df_all$species=='X045'])/2)

ranfor_soundtrap_spl <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB,
                                     data = SPL_diff_df_all, 
                                     ntree = 10000, 
                                     importance = TRUE,
                                     replace = FALSE, 
                                     sampsize = c(rf_sampsize,rf_sampsize),
                                     proximity = TRUE)

ranfor_soundtrap_spl
confusionMatrix(ranfor_soundtrap_spl)

## other model diagnostics
plotTrace(ranfor_soundtrap_spl)
pctCorrect(ranfor_soundtrap_spl)
varImpPlot(ranfor_soundtrap_spl)

```

```{r randomForest for reson data}
## load training 2013 data with SPL calculations
train_data <- read.csv(here("R/spreadsheets/SPL_difference/model_input/training_data_spl_diff.csv"))

## select columns we need
train_spl_data <- train_data %>% select(c(species,eventId,spl_diff_16to23_dB,spl_diff_23to46_dB,
                                          spl_diff_16to25_TOL_dB,spl_diff_25to40_TOL_dB))

## modify species code to match testing dataset
train_spl_data$species[train_spl_data$species==85] <- 'X085'
train_spl_data$species[train_spl_data$species==45] <- 'X045'

## make sure species is a factor
train_spl_data$species <- as.factor(train_spl_data$species)

## run random forest model with TOL frequency bands
ranfor_reson_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = train_spl_data, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize,rf_sampsize), 
                       proximity = TRUE)

ranfor_reson_tol
confusionMatrix(ranfor_reson_tol)

## calculate accuracy and sensitivity to sampsize parameter
RF_sampsize_sensitivity_tol(train_spl_data)
# accuracy varies by <2.5%

## other model diagnostics
casePredictions(ranfor_reson_tol)
predictions <- casePredictions(ranfor_reson_tol)
train_spl_data[predictions$is.correct==FALSE,] # event 757
varImpPlot(ranfor_reson_tol)

## run random forest model with target frequency bands
## calculate sampsize as half the sample size of the smaller species class (=beluga)
rf_sampsize <- ceiling(length(train_spl_data$species[train_spl_data$species=='X045'])/2)

ranfor_reson <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = train_spl_data, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize,rf_sampsize), 
                       proximity = TRUE)

ranfor_reson
confusionMatrix(ranfor_reson)

## other model diagnostics
plotTrace(ranfor_reson)
plotVotes(ranfor_reson)
casePredictions(ranfor_reson)
varImpPlot(ranfor_reson)

```

# SoundTrap and Reson data predictions

```{r use reson data to predict SoundTrap}
## model with specific frequency band vars
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## model with TOL vars
y_pred <- predict(ranfor_reson_tol, newdata=SPL_diff_df_all[,5:6])
confusionMatrix_predict(y_pred,SPL_diff_df_all)

## model with specific freq bands
# y_pred <- predict(ranfor_reson, newdata=SPL_diff_df_all[,2:3], type='prob') # to get votes for each event
y_pred <- predict(ranfor_reson, newdata=SPL_diff_df_all[,3:4])
confusionMatrix_predict(y_pred,SPL_diff_df_all)

```

```{r use SoundTrap to predict reson}
## make sure species is a factor
SPL_diff_df_all$species <- as.factor(SPL_diff_df_all$species)

## model with tol bands
y_pred <- predict(ranfor_soundtrap_spl_tol, newdata=train_spl_data[,4:5])
confusionMatrix_predict(y_pred,train_spl_data)

## model with specific freq bands
y_pred <- predict(ranfor_soundtrap_spl, newdata=train_spl_data[,2:3])
confusionMatrix_predict(y_pred,train_spl_data)

```

# RF models for Fisher and Kong

```{r run separate RF models for Fisher and Kong}
## make sure species is a factor
fish_test_data_select$species <- as.factor(fish_test_data_select$species)
kong_test_data_select$species <- as.factor(kong_test_data_select$species)

## calculate sampsize as half the sample size of the smaller species class (=beluga)
rf_sampsize_fish <- ceiling(length(fish_test_data_select$species[fish_test_data_select$species=='X045'])/2)
rf_sampsize_kong <- ceiling(length(kong_test_data_select$species[kong_test_data_select$species=='X045'])/2)

## Fisher Islands 

## run random forest model - TOL
ranfor_fish_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = fish_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize_fish,rf_sampsize_fish), 
                       proximity = TRUE)

ranfor_fish_tol
confusionMatrix(ranfor_fish_tol)

## calculate accuracy and sensitivity to sampsize parameter
RF_sampsize_sensitivity_tol(fish_test_data_select)
# accuracy varies by <0.9%

## run random forest model
ranfor_fish <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = fish_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize_fish,rf_sampsize_fish), 
                       proximity = TRUE)

ranfor_fish
confusionMatrix(ranfor_fish)

## Kong Oscar 

## run random forest model - TOL
ranfor_kong_tol <- randomForest(species ~ spl_diff_16to25_TOL_dB + spl_diff_25to40_TOL_dB, 
                       data = kong_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize_kong,rf_sampsize_kong), 
                       proximity = TRUE)

ranfor_kong_tol
confusionMatrix(ranfor_kong_tol)

## calculate accuracy and sensitivity to sampsize parameter
RF_sampsize_sensitivity_tol(kong_test_data_select)
# accuracy varies by 0%

## run random forest model
ranfor_kong <- randomForest(species ~ spl_diff_16to23_dB + spl_diff_23to46_dB, 
                       data = kong_test_data_select, 
                       ntree = 10000, 
                       importance = TRUE,
                       replace = FALSE,
                       sampsize = c(rf_sampsize_kong,rf_sampsize_kong),
                       proximity = TRUE)

ranfor_kong
confusionMatrix(ranfor_kong)

```

```{r Use one dataset to predict the other}
## with TOL bands
## fisher predicts kong
y_pred_kong_tol <- predict(ranfor_fish_tol, newdata=kong_test_data_select[,5:6])
confusionMatrix_predict(y_pred_kong_tol,kong_test_data_select)
## kong predicts fisher
y_pred_fish_tol <- predict(ranfor_kong_tol, newdata=fish_test_data_select[,5:6])
confusionMatrix_predict(y_pred_fish_tol,fish_test_data_select)

## with selected freq bands
## fisher predicts kong
y_pred_kong <- predict(ranfor_fish, newdata=kong_test_data_select[,3:4])
confusionMatrix_predict(y_pred_kong,kong_test_data_select)
## kong predicts fisher
y_pred_fish <- predict(ranfor_kong, newdata=fish_test_data_select[,3:4])
confusionMatrix_predict(y_pred_fish,fish_test_data_select)
```


```{r importance scores and plotVotes}
# look at which variable is most important for species classification
importance(ranfor_soundtrap_spl_tol)

# plot Votes to assess overall model confidence in predictions


```

